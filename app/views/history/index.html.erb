<%= profile_page 'History', json: true, csv: true do %>
  <%= form_tag bulk_delete_profile_results_path, method: :delete do %>
  <div class="pull-right">
    <%= submit_tag "Delete", class: "btn btn-danger bulk-edit-control",
                                      data: { confirm: "Are you sure you want to permanently delete the selected results?" } %>
    <%= button_tag "Cancel", type: :reset, id: "bulk_edit_cancel", class: "btn bulk-edit-control" %>
  </div>
  <h2>History</h2>

  <%= render partial: '/layouts/notifications' %>

  <% if Result.modes.has_key?(params[:mode]) %>
    <%= render(partial: '/layouts/filter', locals: {name: 'Mode', label: params[:mode].capitalize, param: :mode}) %>
  <% end %>

  <% if @arena %>
    <%= render(partial: '/layouts/filter', locals: {name: 'Arena Run', label: "#{hero_label(@arena.hero.name)} (#{arena_result(@arena)})", param: :arena_id}) %>
  <% end %>

  <% if @results.empty? %>
  <p class="alert alert-info">
    No results uploaded yet. Play a game or two while Track-o-Bot is running.
  </p>
  <% else %>
    <div class="panel panel-default">
      <table class="table table-hover table-condensed history">
        <tbody>
        <% @results.each do |result| %>
          <tr>
            <td class="choose">
              <%= check_box_tag "result_ids[]", result.id, false, autocomplete: "off", class: "bulk-edit-control bulk-edit-picker"%>
            </td>
            <td class="player">
              <%= player_label_for_result result, card_history_additions(result.player_card_histories) %>
            </td>
            <td class="opponent">vs <%= opponent_label_for_result result, card_history_additions(result.opponent_card_histories) %></td>
            <td class="result"><span class="<%= result.win ? 'win' : 'loss' %>"><%= result.win ? 'Win' : 'Loss' %></span></td>
            <td class="timeline"><%= link_to image_tag('crossed_swords_14.png'), 'javascript:;', timeline_additions(result) if result.card_histories.any? %></td>
            <td class="mode">
              <%# <%= link_to result.mode.capitalize, params.merge(mode: result.mode).except(:page) %1> %>
              <div class="tagging">
                <ul class="tags" 
                  data-immutable-tags="<%= Result.modes.keys.join(',') %>"
                  data-update-url="<%= set_tags_profile_result_path(result) %>"
                  data-update-method="PUT">
                  <li><%= result.mode %></li>
                  <% result.tags.each do |tag| %>
                    <%= content_tag :li, tag.tag %>
                  <% end %>
                </ul>
                <input class="input">
              </div>
            </td>
            <td class="timestamp <%= 'with-duration' if result.duration %>">
              <span class="added"><%= local_time_ago(result.created_at) %></span>
              <% if result.duration %>
                <span class="duration"><i class="fa fa-clock-o"></i> <%= match_duration(result.duration) %></span>
              <% end %>
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <% end %> <!-- form end -->

  <div class="text-right">
    <%= page_entries_info @results %>
  </div>

  <div class="text-center">
    <%= paginate @results, window: 1 %>
  </div>
<% end %>
